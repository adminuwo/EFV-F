<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal | EFV&trade;?</title>

    <!-- CSS Links -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/animations.css">
    <link rel="stylesheet" href="css/responsive.css">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- Immediate Auth Check: Prevents content flash -->
    <script>
        (function () {
            const userData = JSON.parse(localStorage.getItem('EFV&trade;_user'));
            const isAdmin = sessionStorage.getItem('adminLoggedIn') === 'true' ||
                (userData && userData.email && userData.email.toLowerCase() === 'admin@uwo24.com');

            if (!isAdmin) {
                window.location.href = 'index.html';
                return;
            }
            // If admin, hide content until page is fully ready
            document.documentElement.style.visibility = 'hidden';
            window.addEventListener('DOMContentLoaded', () => {
                document.documentElement.style.visibility = 'visible';
            });
        })();
    </script>

    <style>
        .admin-section {
            padding-top: 140px;
            min-height: 80vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .login-box {
            max-width: 400px;
            width: 100%;
            text-align: center;
        }

        .admin-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 50px;
            padding: 15px 25px;
            color: var(--white-text);
            font-family: 'Inter', sans-serif;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1rem;
            transition: var(--transition);
        }

        .admin-input:focus {
            outline: none;
            border-color: var(--gold-energy);
            background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 15px rgba(255, 211, 105, 0.2);
        }

        .error-msg {
            color: #ff4d4d;
            font-size: 0.9rem;
            margin-top: 10px;
            display: none;
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }
        }

        #admin-dashboard {
            display: none;
            width: 100%;
        }

        .dashboard-grid {
            margin-top: 40px;
        }

        /* Hide cart count for Admin Side */
        #cart-count {
            display: none !important;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
        }

        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body data-page="admin">
    <!-- Global cosmic background will be initialized by particles.js -->
    <div id="particles-js"></div>

    <!-- Navbar -->
    <nav>
        <div class="container">
            <a href="index.html" class="logo">
                <img src="img/AISA.svg" alt="AISA Logo">
                <span>EFV<sup>TM</sup></span>
            </a>
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="about.html">About</a></li>
                <li><a href="gallery.html">Gallery</a></li>
                <li><a href="marketplace.html">Marketplace</a></li>
                <li><a href="Feedback.html">Feedback</a></li>
                <li><a href="contact.html">Contact</a></li>
                <li><a href="admin.html" class="active gold-text">Admin</a></li>
            </ul>
            <div class="nav-actions">
                <a href="javascript:void(0)" class="btn btn-gold login-btn"
                    style="padding: 10px 22px; font-size: 0.8rem; border-radius: 50px; text-decoration: none; color: var(--cosmic-black);">Login</a>
                <button class="hamburger" aria-label="Menu">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Admin Login Section -->
    <section id="admin-login" class="section admin-section">
        <div class="container">
            <div class="glass-panel login-box reveal relative-centered">
                <div class="glow-circle"
                    style="width: 80px; height: 80px; border-radius: 50%; border: 2px solid var(--gold-energy); margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 20px rgba(255, 211, 105, 0.3);">
                    <i class="fas fa-user-shield gold-text" style="font-size: 1.8rem;"></i>
                </div>
                <h2>Admin Login</h2>
                <p style="margin-bottom: 30px; font-size: 0.9rem;">Enter your Admin ID to access the dashboard.</p>

                <form id="login-form">
                    <input type="email" id="admin-email" class="admin-input" placeholder="Admin Email" required
                        autocomplete="off">
                    <input type="password" id="admin-password" class="admin-input" placeholder="Password" required
                        autocomplete="off">
                    <button type="submit" class="btn btn-gold" style="width: 100%;">Login</button>
                    <div id="login-error" class="error-msg">Invalid Credentials. Please try again.</div>
                </form>
            </div>
        </div>
    </section>

    <!-- Admin Dashboard (Protected) -->
    <section id="admin-dashboard" class="section">
        <div class="container">
            <div class="text-center mb-50" style="padding-top: 80px;">
                <h2 class="slide-blur-in">Welcome, <span class="gold-text">Admin</span></h2>
                <div class="wave-underline" style="margin: 20px auto; width: 60px;"></div>
            </div>

            <!-- Dashboard Stats -->
            <div class="grid-4 dashboard-grid" style="margin-bottom: 40px;">
                <div class="glass-panel text-center reveal">
                    <i class="fas fa-boxes gold-text" style="font-size: 2rem; margin-bottom: 15px;"></i>
                    <h3 id="stat-total-products">0</h3>
                    <p>Total Books</p>
                </div>
                <div class="glass-panel text-center reveal delay-1">
                    <i class="fas fa-shopping-bag gold-text" style="font-size: 2rem; margin-bottom: 15px;"></i>
                    <h3 id="stat-total-orders">0</h3>
                    <p>Total Orders</p>
                </div>
                <div class="glass-panel text-center reveal delay-2">
                    <i class="fas fa-coins gold-text" style="font-size: 2rem; margin-bottom: 15px;"></i>
                    <h3 id="stat-revenue">?0</h3>
                    <p>Total Revenue</p>
                </div>
                <div class="glass-panel text-center reveal delay-3">
                    <i class="fas fa-shipping-fast gold-text" style="font-size: 2rem; margin-bottom: 15px;"></i>
                    <h3 id="stat-pending">0</h3>
                    <p>Pending Orders</p>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs" style="display: flex; justify-content: center; gap: 20px; margin-bottom: 30px;">
                <button class="btn btn-gold active" onclick="switchTab('products')">Manage Products</button>
                <button class="btn btn-outline" onclick="switchTab('orders')">Manage Orders</button>
            </div>

            <!-- Product Management Section -->
            <div id="tab-products" class="tab-content" style="display: block;">
                <div class="glass-panel" style="overflow-x: auto;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>Product Catalog</h3>
                        <button class="btn btn-gold" onclick="openAddProductModal()">+ Add Book</button>
                    </div>
                    <table class="admin-table" style="width: 100%; border-collapse: collapse; color: white;">
                        <thead>
                            <tr style="border-bottom: 1px solid rgba(255,255,255,0.1); text-align: left;">
                                <th style="padding: 15px;">Image</th>
                                <th style="padding: 15px;">Title</th>
                                <th style="padding: 15px;">Type</th>
                                <th style="padding: 15px;">Price</th>
                                <th style="padding: 15px;">Stock</th>
                                <th style="padding: 15px;">Total Buyers</th>
                                <th style="padding: 15px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="product-table-body">
                            <!-- Populated via JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Order Management Section -->
            <div id="tab-orders" class="tab-content" style="display: none;">
                <div class="glass-panel" style="overflow-x: auto;">
                    <h3>Order Management</h3>
                    <table class="admin-table" style="width: 100%; border-collapse: collapse; color: white;">
                        <thead>
                            <tr style="border-bottom: 1px solid rgba(255,255,255,0.1); text-align: left;">
                                <th style="padding: 15px;">Order ID</th>
                                <th style="padding: 15px;">Customer</th>
                                <th style="padding: 15px;">Items</th>
                                <th style="padding: 15px;">Total</th>
                                <th style="padding: 15px;">Status</th>
                                <th style="padding: 15px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="order-table-body">
                            <!-- Populated via JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>

    <!-- Product Modal -->
    <div id="product-modal" class="modal-overlay"
        style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center;">
        <div class="glass-panel" style="max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <h2 id="modal-title" style="margin-bottom: 20px;">Add New Book</h2>
            <form id="product-form">
                <input type="hidden" id="product-id">

                <div class="form-group" style="margin-bottom: 15px;">
                    <label>Title</label>
                    <input type="text" id="prod-title" class="admin-input" required>
                </div>

                <div class="form-group" style="margin-bottom: 15px;">
                    <label>Type</label>
                    <select id="prod-type" class="admin-input" onchange="toggleFileFields()">
                        <option value="HARDCOVER">Hardcover</option>
                        <option value="PAPERBACK">Paperback</option>
                        <option value="EBOOK">E-book (PDF)</option>
                        <option value="AUDIOBOOK">Audiobook (MP3)</option>
                    </select>
                </div>

                <div class="grid-2" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Volume Number</label>
                        <input type="number" id="prod-volume" class="admin-input" placeholder="e.g. 1">
                    </div>
                    <div class="form-group">
                        <label>Language</label>
                        <select id="prod-lang" class="admin-input">
                            <option value="English">English</option>
                            <option value="Hindi">Hindi</option>
                            <option value="Spanish">Spanish</option>
                        </select>
                    </div>
                </div>

                <div class="form-group" style="margin-bottom: 15px;">
                    <label>Subtitle</label>
                    <input type="text" id="prod-subtitle" class="admin-input">
                </div>

                <div class="form-group" style="margin-bottom: 15px;">
                    <label>Author</label>
                    <input type="text" id="prod-author" class="admin-input" required>
                </div>

                <div class="form-group" style="margin-bottom: 15px;">
                    <label>Description</label>
                    <textarea id="prod-desc" class="admin-input" rows="3" style="resize: vertical;"></textarea>
                </div>

                <div class="grid-2" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Price (?)</label>
                        <input type="number" id="prod-price" class="admin-input" required>
                    </div>
                    <div class="form-group">
                        <label>Discount (%)</label>
                        <input type="number" id="prod-discount" class="admin-input" value="0">
                    </div>
                </div>

                <div class="form-group" style="margin-bottom: 15px;">
                    <label>Stock</label>
                    <input type="number" id="prod-stock" class="admin-input" value="100">
                </div>

                <!-- File Uploads -->
                <div class="form-group" style="margin-bottom: 15px;">
                    <label>Cover Image</label>
                    <input type="file" id="file-cover" class="admin-input" accept="image/*">
                </div>

                <div id="field-ebook" class="form-group" style="display: none; margin-bottom: 15px;">
                    <label>Upload E-book (PDF)</label>
                    <input type="file" id="file-ebook" class="admin-input" accept="application/pdf">
                </div>

                <div id="field-audio" class="form-group" style="display: none; margin-bottom: 15px;">
                    <label>Upload Audiobook (MP3)</label>
                    <input type="file" id="file-audio" class="admin-input" accept="audio/*">
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-gold" style="flex: 1;">Save Product</button>
                    <button type="button" class="btn btn-outline" style="flex: 1;"
                        onclick="closeProductModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Footer -->
    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-links footer-explore">
                    <h4>Explore</h4>
                    <ul>
                        <li><a href="about.html">About EFV<sup>TM</sup></a></li>
                        <li><a href="uwo.html">About UWO<sup>TM</sup></a></li>
                        <li><a href="gallery.html">Gallery</a></li>
                        <li><a href="terms.html">Terms & Conditions</a></li>
                        <li><a href="marketplace.html">Marketplace</a></li>
                        <li><a href="Feedback.html">Feedback</a></li>
                        <li><a href="contact.html">Contact</a></li>
                        <li><a href="privacy-policy.html">Privacy Policy</a></li>
                    </ul>
                </div>
                <div class="footer-info">
                    <div class="logo footer-logo">
                        <img src="img/AISA.svg" alt="AISA Logo">
                        <span>EFV<sup>TM</sup></span>
                    </div>
                    <p>World's first EFV<sup>TM</sup> system. Designed for better living.</p>
                </div>
                <div class="footer-links footer-connect">
                    <h4>Connect</h4>
                    <div class="social-icons">
                        <a href="https://www.facebook.com/profile.php?id=61585343488735" class="social-icon-link"
                            aria-label="Facebook" target="_blank" rel="noopener noreferrer">
                            <img src="img/FB.svg" alt="Facebook"
                                style="width: 32px; height: 32px; transition: transform 0.3s ease, opacity 0.3s ease;">
                        </a>
                        <a href="https://www.instagram.com/EFV&trade;_framework/" class="social-icon-link"
                            aria-label="Instagram" target="_blank" rel="noopener noreferrer">
                            <img src="img/Insta (1).svg" alt="Instagram"
                                style="width: 32px; height: 32px; transition: transform 0.3s ease, opacity 0.3s ease;">
                        </a>
                        <a href="https://www.linkedin.com/in/EFV&trade;-framework/" class="social-icon-link"
                            aria-label="LinkedIn" target="_blank" rel="noopener noreferrer">
                            <img src="img/Linkedin.svg" alt="LinkedIn"
                                style="width: 32px; height: 32px; transition: transform 0.3s ease, opacity 0.3s ease;">
                        </a>
                        <a href="https://www.threads.com/@EFV&trade;_framework" class="social-icon-link"
                            aria-label="Threads" target="_blank" rel="noopener noreferrer">
                            <img src="img/Threads.svg" alt="Threads"
                                style="width: 32px; height: 32px; transition: transform 0.3s ease, opacity 0.3s ease;">
                        </a>
                        <a href="https://x.com/EFV&trade;Frame_work" class="social-icon-link" aria-label="X (Twitter)"
                            target="_blank" rel="noopener noreferrer">
                            <img src="img/x.png" alt="X (Twitter)"
                                style="width: 32px; height: 32px; transition: transform 0.3s ease, opacity 0.3s ease;">
                        </a>
                        <a href="#" class="social-icon-link" aria-label="YouTube" target="_blank"
                            rel="noopener noreferrer">
                            <img src="img/YT (1).svg" alt="YouTube"
                                style="width: 32px; height: 32px; transition: transform 0.3s ease, opacity 0.3s ease;">
                        </a>
                        <a href="https://in.pinterest.com/EFV&trade;_Framework/" class="social-icon-link"
                            aria-label="Pinterest" target="_blank" rel="noopener noreferrer">
                            <img src="img/pinterset.png" alt="Pinterest" style="width: 26px; height: 26px;">
                        </a>
                        <a href="mailto:admin@uwo24.com" class="social-icon-link" aria-label="Gmail">
                            <img src="img/gmail.png" alt="Gmail" style="width: 26px; height: 26px;">
                        </a>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                &copy; <a href="https://uwo-743928421487.asia-south1.run.app/index.html" target="_blank"
                    style="color: inherit; text-decoration: none;">UWO<sup>TM</sup></a> &mdash; EFV<sup>TM</sup> is a <a
                    href="https://uwo-743928421487.asia-south1.run.app/index.html" target="_blank"
                    style="color: inherit; text-decoration: none;">UWO<sup>TM</sup></a> Innovation.
            </div>
        </div>
    </footer>

    <!-- JS Scripts -->
    <script src="js/api-config.js"></script>
    <script src="js/particles.js"></script>
    <script src="js/main.js"></script>
    <script src="js/cart.js?v=9.0"></script>

    <!-- Admin Logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const loginSection = document.getElementById('admin-login');
            const dashboardSection = document.getElementById('admin-dashboard');
            const loginForm = document.getElementById('login-form');
            const adminEmailInput = document.getElementById('admin-email');
            const adminPassInput = document.getElementById('admin-password');
            const loginError = document.getElementById('login-error');

            function showDashboard() {
                if (loginSection) loginSection.style.display = 'none';
                if (dashboardSection) dashboardSection.style.display = 'block';

                // Display Dynamic Click Count
                const clickCountElement = document.getElementById('admin-click-count');
                if (clickCountElement) {
                    clickCountElement.textContent = localStorage.getItem('EFV&trade;_cart_clicks') || '0';
                }

                if (window.loadProducts) window.loadProducts();
            }

            // Real-time Dashboard Sync
            window.addEventListener('storage', (e) => {
                if (e.key === 'EFV&trade;_cart_clicks') {
                    const clickCountElement = document.getElementById('admin-click-count');
                    if (clickCountElement) {
                        clickCountElement.textContent = e.newValue || '0';
                    }
                }
            });

            function showLogin() {
                if (dashboardSection) dashboardSection.style.display = 'none';
                if (loginSection) loginSection.style.display = 'flex';
                if (adminEmailInput) adminEmailInput.value = '';
                if (adminPassInput) adminPassInput.value = '';
            }

            // Check session storage or persistent user on load
            if (sessionStorage.getItem('adminLoggedIn') === 'true' ||
                (localStorage.getItem('efv_user') && JSON.parse(localStorage.getItem('efv_user')).email === 'admin@uwo24.com')) {
                showDashboard();
            }

            if (loginForm) {
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = adminEmailInput.value.trim().toLowerCase();
                    const password = adminPassInput.value.trim();
                    const btn = loginForm.querySelector('button');

                    try {
                        const originalText = btn.textContent;
                        btn.textContent = 'Authenticating...';
                        btn.disabled = true;

                        const apiBase = (typeof CONFIG !== 'undefined' && CONFIG.API_BASE_URL) ? CONFIG.API_BASE_URL : 'https://efv-backend-743928421487.asia-south1.run.app';
                        const response = await fetch(`${apiBase}/api/auth/admin/login`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email, password })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            sessionStorage.setItem('adminToken', data.token);
                            sessionStorage.setItem('adminLoggedIn', 'true');
                            localStorage.setItem('efv_user', JSON.stringify({ name: data.name, email: data.email, role: 'admin' }));

                            showDashboard();
                            loginError.style.display = 'none';
                            if (window.updateAdminNavbar) window.updateAdminNavbar();
                        } else {
                            throw new Error(data.message || 'Login failed');
                        }
                    } catch (error) {
                        console.error('Login Error:', error);
                        loginError.textContent = error.message;
                        loginError.style.display = 'block';
                        adminPassInput.value = '';
                    } finally {
                        btn.textContent = 'Login';
                        btn.disabled = false;
                    }
                });
            }

            // Order Management Logic
            const orderTableBody = document.getElementById('order-table-body');
            const statusOptions = ['Pending', 'Confirmed', 'Packed', 'Shipped', 'In Transit', 'Out for Delivery', 'Delivered', 'Failed', 'Returned'];

            window.loadOrders = async function () {
                const token = sessionStorage.getItem('adminToken');
                try {
                    const apiBase = (typeof CONFIG !== 'undefined' && CONFIG.API_BASE_URL) ? CONFIG.API_BASE_URL : 'https://efv-backend-743928421487.asia-south1.run.app';
                    const response = await fetch(`${apiBase}/api/orders`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const orders = await response.json();

                    if (orderTableBody) {
                        orderTableBody.innerHTML = '';
                        orders.forEach(order => {
                            const tr = document.createElement('tr');
                            tr.style.borderBottom = '1px solid rgba(255,255,255,0.1)';

                            // Status Dropdown
                            let statusSelect = `<select onchange="updateOrderStatus('${order._id}', this.value)" style="background: rgba(0,0,0,0.5); color: white; border: 1px solid #d4af37; padding: 5px; border-radius: 4px;">`;
                            statusOptions.forEach(opt => {
                                statusSelect += `<option value="${opt}" ${order.status === opt ? 'selected' : ''}>${opt}</option>`;
                            });
                            statusSelect += `</select>`;

                            const itemsSummary = order.items.map(i => `${i.quantity}x ${i.title}`).join('<br>');

                            tr.innerHTML = `
                                <td style="padding: 15px; font-family: monospace;">${order._id}</td>
                                <td style="padding: 15px;">${order.customer.name}<br><span style="font-size: 0.8rem; color: #aaa;">${order.customer.email}</span></td>
                                <td style="padding: 15px; font-size: 0.9rem;">${itemsSummary}</td>
                                <td style="padding: 15px;">?${order.totalAmount}</td>
                                <td style="padding: 15px;">${statusSelect}</td>
                                <td style="padding: 15px;">
                                    <button onclick="viewOrderDetails('${order._id}')" class="btn btn-outline" style="padding: 5px 10px; font-size: 0.8rem;">View</button>
                                </td>
                            `;
                            orderTableBody.appendChild(tr);
                        });

                        // Update Dashboard Stats
                        if (document.getElementById('stat-total-orders'))
                            document.getElementById('stat-total-orders').textContent = orders.length;

                        const revenue = orders.reduce((sum, o) => sum + (o.status !== 'Failed' && o.status !== 'Returned' ? o.totalAmount : 0), 0);
                        if (document.getElementById('stat-revenue'))
                            document.getElementById('stat-revenue').textContent = '?' + revenue.toLocaleString();

                        const pending = orders.filter(o => o.status === 'Pending').length;
                        if (document.getElementById('stat-pending'))
                            document.getElementById('stat-pending').textContent = pending;
                    }
                } catch (error) {
                    console.error('Error loading orders:', error);
                }
            };

            window.updateOrderStatus = async function (id, newStatus) {
                const token = sessionStorage.getItem('adminToken');
                const note = prompt(`Enter a note for status change to ${newStatus}:`, `Order marked as ${newStatus}`);
                if (note === null) return; // Cancelled

                try {
                    const apiBase = (typeof CONFIG !== 'undefined' && CONFIG.API_BASE_URL) ? CONFIG.API_BASE_URL : 'https://efv-backend-743928421487.asia-south1.run.app';
                    const response = await fetch(`${apiBase}/api/orders/${id}/status`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ status: newStatus, note: note })
                    });

                    if (response.ok) {
                        // refresh to show latest
                        loadOrders();
                    } else {
                        alert('Failed to update status');
                    }
                } catch (error) {
                    console.error(error);
                    alert('Server error');
                }
            };

            // Product Management Logic
            const productForm = document.getElementById('product-form');
            const productTableBody = document.getElementById('product-table-body');

            window.switchTab = function (tabName) {
                document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
                document.querySelectorAll('.tabs .btn').forEach(el => el.classList.remove('btn-gold'));
                document.querySelectorAll('.tabs .btn').forEach(el => el.classList.add('btn-outline'));

                document.getElementById(`tab-${tabName}`).style.display = 'block';

                // Highlight active button
                const activeBtn = document.querySelector(`button[onclick="switchTab('${tabName}')"]`);
                if (activeBtn) {
                    activeBtn.classList.remove('btn-outline');
                    activeBtn.classList.add('btn-gold');
                }

                if (tabName === 'products') loadProducts();
                if (tabName === 'orders') loadOrders();
            };

            window.loadProducts = async function () {
                try {
                    const token = sessionStorage.getItem('adminToken');

                    const apiBase = (typeof CONFIG !== 'undefined' && CONFIG.API_BASE_URL) ? CONFIG.API_BASE_URL : 'https://efv-backend-743928421487.asia-south1.run.app';
                    // Fetch products and orders in parallel
                    const [productsRes, ordersRes] = await Promise.all([
                        fetch(`${apiBase}/api/products`),
                        fetch(`${apiBase}/api/orders`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        })
                    ]);

                    const products = await productsRes.json();
                    const orders = ordersRes.ok ? await ordersRes.json() : [];

                    // Calculate buyer count for each product
                    const buyerCount = {};
                    orders.forEach(order => {
                        order.items.forEach(item => {
                            if (!buyerCount[item.productId]) {
                                buyerCount[item.productId] = new Set();
                            }
                            buyerCount[item.productId].add(order.customer.email);
                        });
                    });

                    if (productTableBody) {
                        productTableBody.innerHTML = '';

                        // Group products by volume
                        const volumeGroups = {};
                        products.forEach(p => {
                            const volNum = p.volume || 'Unassigned';
                            if (!volumeGroups[volNum]) volumeGroups[volNum] = [];
                            volumeGroups[volNum].push(p);
                        });

                        // Sort volumes
                        const sortedVolumes = Object.keys(volumeGroups).sort((a, b) => {
                            if (a === 'Unassigned') return 1;
                            if (b === 'Unassigned') return -1;
                            return a - b;
                        });

                        sortedVolumes.forEach(volNum => {
                            const volProducts = volumeGroups[volNum];

                            // Add volume header row
                            if (volNum !== 'Unassigned') {
                                const headerRow = document.createElement('tr');
                                headerRow.style.background = 'rgba(212, 175, 55, 0.1)';
                                headerRow.style.borderTop = '2px solid rgba(212, 175, 55, 0.3)';
                                headerRow.innerHTML = `
                                    <td colspan="7" style="padding: 10px 15px; font-weight: bold; color: var(--gold-energy);">
                                        <i class="fas fa-book"></i> EFV&trade;? Volume ${volNum} (${volProducts.length} formats)
                                    </td>
                                `;
                                productTableBody.appendChild(headerRow);
                            }

                            // Add individual products
                            volProducts.forEach(p => {
                                const buyers = buyerCount[p._id] ? buyerCount[p._id].size : 0;
                                const tr = document.createElement('tr');
                                tr.style.borderBottom = '1px solid rgba(255,255,255,0.1)';
                                tr.innerHTML = `
                                    <td style="padding: 15px;"><img src="${p.thumbnail ? (p.thumbnail.startsWith('http') ? p.thumbnail : (typeof CONFIG !== 'undefined' && CONFIG.API_BASE_URL ? CONFIG.API_BASE_URL : 'https://efv-backend-743928421487.asia-south1.run.app') + '/' + p.thumbnail.replace('src/', '')) : 'img/placeholder.png'}" style="width: 50px; height: 75px; object-fit: cover; border-radius: 4px;"></td>
                                    <td style="padding: 15px;">${p.title}<br><span style="font-size: 0.8rem; color: #aaa;">${p.category || p.type}</span></td>
                                    <td style="padding: 15px;">${p.type}</td>
                                    <td style="padding: 15px;">?${p.price}</td>
                                    <td style="padding: 15px;">${p.stock || '-'}</td>
                                    <td style="padding: 15px;">
                                        <span style="background: ${buyers > 0 ? 'rgba(16, 185, 129, 0.2)' : 'rgba(255,255,255,0.05)'}; padding: 5px 12px; border-radius: 12px; color: ${buyers > 0 ? '#10b981' : '#888'}; font-weight: bold;">
                                            <i class="fas fa-users"></i> ${buyers}
                                        </span>
                                    </td>
                                    <td style="padding: 15px;">
                                        <button onclick="deleteProduct('${p._id}')" class="btn btn-outline" style="padding: 5px 10px; font-size: 0.8rem; border-color: #ff4d4d; color: #ff4d4d;"><i class="fas fa-trash"></i></button>
                                    </td>
                                `;
                                productTableBody.appendChild(tr);
                            });
                        });

                        if (document.getElementById('stat-total-products'))
                            document.getElementById('stat-total-products').textContent = products.length;
                    }

                } catch (error) {
                    console.error('Error loading products:', error);
                }
            };

            window.toggleFileFields = function () {
                const type = document.getElementById('prod-type').value;
                const ebookField = document.getElementById('field-ebook');
                const audioField = document.getElementById('field-audio');
                if (ebookField) ebookField.style.display = type === 'EBOOK' ? 'block' : 'none';
                if (audioField) audioField.style.display = type === 'AUDIOBOOK' ? 'block' : 'none';
            };

            window.openAddProductModal = function () {
                if (document.getElementById('product-form')) document.getElementById('product-form').reset();
                if (document.getElementById('product-id')) document.getElementById('product-id').value = '';
                if (document.getElementById('modal-title')) document.getElementById('modal-title').textContent = 'Add New Book';
                if (document.getElementById('product-modal')) document.getElementById('product-modal').style.display = 'flex';
                toggleFileFields();
            };

            window.closeProductModal = function () {
                if (document.getElementById('product-modal')) document.getElementById('product-modal').style.display = 'none';
            };

            window.deleteProduct = async function (id) {
                if (!confirm('Are you sure you want to delete this book?')) return;

                const token = sessionStorage.getItem('adminToken');
                try {
                    const apiBase = (typeof CONFIG !== 'undefined' && CONFIG.API_BASE_URL) ? CONFIG.API_BASE_URL : 'https://efv-backend-743928421487.asia-south1.run.app';
                    const response = await fetch(`${apiBase}/api/products/${id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.ok) {
                        loadProducts();
                    } else {
                        alert('Failed to delete product');
                    }
                } catch (error) {
                    console.error(error);
                }
            };

            if (productForm) {
                productForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const token = sessionStorage.getItem('adminToken');
                    if (!token) {
                        alert('Session expired. Please login again.');
                        showLogin();
                        return;
                    }

                    const submitBtn = productForm.querySelector('button[type="submit"]');
                    submitBtn.textContent = 'Saving...';
                    submitBtn.disabled = true;

                    /* 1. Upload Files first */
                    const formData = new FormData();
                    const coverElement = document.getElementById('file-cover');
                    const ebookElement = document.getElementById('file-ebook');
                    const audioElement = document.getElementById('file-audio');

                    const coverFile = coverElement ? coverElement.files[0] : null;
                    const ebookFile = ebookElement ? ebookElement.files[0] : null;
                    const audioFile = audioElement ? audioElement.files[0] : null;

                    if (coverFile) formData.append('cover', coverFile);
                    if (ebookFile) formData.append('ebook', ebookFile);
                    if (audioFile) formData.append('audio', audioFile);

                    let uploadData = {};
                    if (coverFile || ebookFile || audioFile) {
                        try {
                            const apiBase = (typeof CONFIG !== 'undefined' && CONFIG.API_BASE_URL) ? CONFIG.API_BASE_URL : 'https://efv-backend-743928421487.asia-south1.run.app';
                            const uploadRes = await fetch(`${apiBase}/api/upload`, {
                                method: 'POST',
                                headers: { 'Authorization': `Bearer ${token}` },
                                body: formData
                            });
                            const result = await uploadRes.json();
                            if (result.paths) uploadData = result.paths;

                            // Normalize paths (remove 'src/' prefix if present for serving)
                            if (uploadData.coverPath) uploadData.coverPath = uploadData.coverPath.replace(/\\/g, '/');
                            if (uploadData.ebookPath) uploadData.ebookPath = uploadData.ebookPath.replace(/\\/g, '/');
                            if (uploadData.audioPath) uploadData.audioPath = uploadData.audioPath.replace(/\\/g, '/');

                        } catch (err) {
                            console.error('Upload failed:', err);
                            alert('File upload failed. Please try again.');
                            submitBtn.textContent = 'Save Product';
                            submitBtn.disabled = false;
                            return;
                        }
                    }

                    /* 2. Create Product Object */
                    const productData = {
                        title: document.getElementById('prod-title').value,
                        subtitle: document.getElementById('prod-subtitle').value,
                        author: document.getElementById('prod-author').value,
                        language: document.getElementById('prod-lang').value,
                        description: document.getElementById('prod-desc').value,
                        type: document.getElementById('prod-type').value,
                        category: document.getElementById('prod-type').value,
                        price: Number(document.getElementById('prod-price').value),
                        discount: Number(document.getElementById('prod-discount').value) || 0,
                        stock: Number(document.getElementById('prod-stock').value) || 0,
                        thumbnail: uploadData.coverPath ? uploadData.coverPath : undefined,
                        filePath: uploadData.ebookPath || uploadData.audioPath || undefined,
                        volume: document.getElementById('prod-volume').value
                    };

                    try {
                        const apiBase = (typeof CONFIG !== 'undefined' && CONFIG.API_BASE_URL) ? CONFIG.API_BASE_URL : 'https://efv-backend-743928421487.asia-south1.run.app';
                        const res = await fetch(`${apiBase}/api/products`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify(productData)
                        });

                        if (res.ok) {
                            closeProductModal();
                            loadProducts();
                        } else {
                            const json = await res.json();
                            alert(json.message || 'Error saving product');
                        }
                    } catch (err) {
                        console.error(err);
                        alert('Server error');
                    } finally {
                        submitBtn.textContent = 'Save Product';
                        submitBtn.disabled = false;
                    }
                });
            }

        });
    </script>
    <script src="js/efv-fx.js"></script>
</body>

</html>